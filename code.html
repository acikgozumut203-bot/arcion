const API_URL = "http://localhost:3000/api/codes";

const codeList = document.getElementById("codeList");
const searchInput = document.getElementById("searchInput");

let allCodes = [];

// Kodları backend'den çek
async function fetchCodes() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    allCodes = data;
    renderCodes(allCodes);
  } catch (err) {
    codeList.innerHTML = "<p>❌ Kodlar yüklenemedi</p>";
    console.error(err);
  }
}

// Kodları ekrana bas
function renderCodes(codes) {
  codeList.innerHTML = "";

  if (codes.length === 0) {
    codeList.innerHTML = "<p>Henüz kod yok</p>";
    return;
  }

  codes.forEach(code => {
    const card = document.createElement("div");
    card.className = "code-card";

    card.innerHTML = `
      <h2>${code.title}</h2>
      <span class="language">${code.language}</span>
      <p class="description">${code.description}</p>
      <pre><code class="language-${code.language.toLowerCase()}">
${escapeHtml(code.code)}
      </code></pre>
    `;

    codeList.appendChild(card);
  });

  if (window.hljs) {
    hljs.highlightAll();
  }
}

// Arama (başlığa göre)
searchInput.addEventListener("input", e => {
  const value = e.target.value.toLowerCase();

  const filtered = allCodes.filter(code =>
    code.title.toLowerCase().includes(value)
  );

  renderCodes(filtered);
});

// Güvenli HTML
function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// Sayfa açılınca
fetchCodes();
